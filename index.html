<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPPG BERITA ACARA | V21 Precision</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-pdfmake/browser.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
        }

        /* Editor A4 */
        #editor { 
            min-height: 29.7cm; 
            width: 21cm; 
            max-width: 100%;
            padding: 2.54cm 2cm 2.54cm 3cm; /* Margin: Atas/Bawah/Kanan 2.54cm, Kiri 3cm */
            margin: 0 auto;
            outline: none; 
            line-height: 1.25; 
            color: #000;
            background: white;
            font-family: 'Times New Roman', serif; 
            font-size: 12pt;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            text-align: justify;
        }
        #editor ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; }
        #editor ol { list-style-type: decimal; margin-left: 1.5em; margin-bottom: 1em; }
        #editor li { padding-left: 5px; margin-bottom: 6px; } 
        #editor p { margin-bottom: 1em; }

        .input-std {
            width: 100%; padding: 8px 12px; font-size: 13px;
            border: 1px solid #cbd5e1; border-radius: 8px; background: #fff;
            transition: all 0.2s;
        }
        .input-std:focus { border-color: #4f46e5; ring: 2px solid #e0e7ff; outline: none; }
        
        .btn-press:active { transform: scale(0.98); }
    </style>
</head>
<body class="pb-24">

    <div class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-slate-200 px-6 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-700 text-white w-10 h-10 rounded-xl flex items-center justify-center font-extrabold text-sm shadow-lg">BA</div>
            <div>
                <h1 class="font-bold text-slate-900 text-base leading-tight">SPPG BERITA ACARA</h1>
                <p class="text-[11px] text-slate-500 font-medium">by Fadlan Kharisma</p>
            </div>
        </div>
        <button onclick="simpanApp()" class="btn-press bg-slate-900 text-white px-5 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-slate-800 transition flex gap-2 items-center">
            üíæ SIMPAN APP
        </button>
    </div>

    <div class="max-w-[1600px] mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-2">
        
        <div class="lg:col-span-4 space-y-5">
            
            <div class="glass-panel p-5">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xs font-bold uppercase text-indigo-600 tracking-widest">üß† Otak AI</h2>
                    <span id="statusAI" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-400 font-bold">Offline</span>
                </div>
                <div class="space-y-3">
                    <div class="relative">
                        <input type="password" id="apiKey" class="input-std pr-8" placeholder="Paste API Key Gemini...">
                        <button onclick="togglePass()" class="absolute right-3 top-2 text-slate-400 hover:text-indigo-600">üëÅÔ∏è</button>
                    </div>
                    <div class="flex gap-2">
                        <select id="modelSelect" class="input-std bg-slate-50 font-mono text-xs">
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash (Default)</option>
                        </select>
                        <button onclick="cekKoneksi()" class="btn-press bg-indigo-50 text-indigo-600 px-3 rounded-lg border border-indigo-100 font-bold text-xs w-24">üîÑ Cek</button>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5">
                <div class="flex justify-between mb-3">
                    <h2 class="text-xs font-bold uppercase text-slate-500 tracking-widest">Identitas Instansi</h2>
                    <button onclick="hapusLogo()" class="text-[10px] text-red-500 font-bold hover:underline">Reset Logo</button>
                </div>
                
                <div class="flex gap-3 mb-4 items-center">
                    <div id="logoBox" class="hidden w-16 h-16 bg-white border border-slate-200 rounded-lg p-1 flex items-center justify-center relative shadow-sm">
                        <img id="logoImg" class="max-w-full max-h-full object-contain">
                    </div>
                    <label class="flex-1 h-16 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition group">
                        <span class="text-xl group-hover:scale-110 transition">üì∑</span>
                        <span class="text-[10px] text-slate-400">Upload Logo (Auto-White)</span>
                        <input type="file" id="logoInput" accept="image/*" class="hidden">
                    </label>
                    <canvas id="compressCanvas" class="hidden"></canvas>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Nama Instansi</label>
                        <input type="text" id="namaInstansi" class="input-std font-bold uppercase" value="BADAN GIZI NASIONAL">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Unit Pelayanan</label>
                        <input type="text" id="alamatInstansi" class="input-std font-bold" value="SPPG KULON PROGO PANJATAN PANJATAN 2">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Alamat</label>
                        <input type="text" id="alamatLengkap" class="input-std text-xs" value="Ds 2 Rt 08 Rw 04, Panjatan, Kulon Progo, Yogyakarta">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">Kontak</label>
                        <input type="text" id="kontakInstansi" class="input-std text-xs text-blue-600" value="+62 821-3375-2141 | sppgpanjatan002@gmail.com">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5">
                <h2 class="text-xs font-bold uppercase text-slate-500 mb-3 tracking-widest">Detail Dokumen</h2>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">No. Urut</label>
                        <input type="text" id="noUrut" class="input-std font-mono font-bold text-center" value="BA-001">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Tanggal</label>
                        <input type="date" id="tglSurat" class="input-std text-center">
                    </div>
                </div>
                <input type="text" id="noSuratFinal" class="w-full bg-slate-100 border-none rounded p-2 text-xs font-mono text-center text-slate-500 mb-4 font-bold" readonly>

                <div class="border-t pt-3 border-slate-100">
                    <div class="flex items-center gap-2 mb-2 cursor-pointer" onclick="document.getElementById('cekHukum').click()">
                        <input type="checkbox" id="cekHukum" onchange="toggleHukum()" class="w-4 h-4 text-indigo-600 rounded cursor-pointer">
                        <span class="text-xs font-bold text-slate-700">Pakai Dasar Hukum?</span>
                    </div>

                    <div id="boxHukum" class="hidden bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                        <div class="flex gap-2">
                            <select id="dbAturan" onchange="pilihAturan()" class="input-std text-xs">
                                <option value="">-- Pilih Aturan --</option>
                            </select>
                            <button onclick="hapusAturan()" class="bg-red-100 text-red-500 px-3 rounded-lg hover:bg-red-200 font-bold">üóëÔ∏è</button>
                        </div>
                        <input type="text" id="dasarNomor" class="input-std text-xs" placeholder="No. Aturan">
                        <input type="date" id="dasarTanggal" class="input-std text-xs">
                        <input type="text" id="dasarPerihal" class="input-std text-xs" placeholder="Perihal">
                        <button onclick="simpanAturan()" class="w-full bg-blue-50 text-blue-600 text-xs py-2 rounded-lg font-bold hover:bg-blue-100 border border-blue-200">
                            üíæ Simpan ke Database
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-1">
                <textarea id="masalah" class="w-full p-4 bg-transparent border-none focus:ring-0 text-sm h-40 placeholder-slate-400 resize-none leading-relaxed" placeholder="Ceritakan kronologi masalahnya. AI akan menyusun kalimatnya agar detail tapi tidak bertele-tele..."></textarea>
            </div>

            <button onclick="generateAI()" class="btn-press w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl hover:bg-slate-800 transition flex justify-center items-center gap-2 group">
                <span class="group-hover:rotate-12 transition">‚ú®</span> BUAT NARASI (PADAT & JELAS)
            </button>
        </div>

        <div class="lg:col-span-8 flex flex-col h-full items-center">
            
            <div class="bg-white border border-slate-200 border-b-0 rounded-t-xl p-2 flex flex-wrap gap-1 sticky top-[68px] z-40 shadow-sm items-center w-full max-w-[21cm]">
                <button onclick="cmd('bold')" class="p-1.5 hover:bg-slate-100 rounded font-bold min-w-[30px]">B</button>
                <button onclick="cmd('italic')" class="p-1.5 hover:bg-slate-100 rounded italic min-w-[30px]">I</button>
                <button onclick="cmd('underline')" class="p-1.5 hover:bg-slate-100 rounded underline min-w-[30px]">U</button>
                <div class="w-px h-6 bg-slate-300 mx-2"></div>
                <button onclick="cmd('insertUnorderedList')" class="p-1.5 hover:bg-slate-100 rounded">‚Ä¢ List</button>
                <button onclick="cmd('insertOrderedList')" class="p-1.5 hover:bg-slate-100 rounded">1. List</button>
                <div class="w-px h-6 bg-slate-300 mx-2"></div>
                <button onclick="cmd('justifyFull')" class="p-1.5 hover:bg-slate-100 rounded bg-slate-100 font-bold text-xs">Rata Kanan-Kiri</button>
            </div>

            <div id="editor" contenteditable="true" class="text-slate-900">
                <p style="text-align: center; color: #cbd5e1; padding-top: 100px;">
                    <em>Isi Berita Acara yang dihasilkan AI akan muncul di sini.</em>
                </p>
            </div>

            <div class="mt-6 bg-white rounded-xl border border-slate-200 p-6 shadow-sm w-full max-w-[21cm]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Penanda Tangan</h3>
                    <button onclick="tambahTTD()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-100 border border-indigo-100">+ Tambah</button>
                </div>
                
                <div id="ttdContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

                <button onclick="downloadPDF()" class="btn-press w-full bg-emerald-600 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition flex justify-center items-center gap-2">
                    üìÑ DOWNLOAD PDF (RAPID & LENGKAP)
                </button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const CONFIG = {
            api: 'sppg_v21_api', logo: 'sppg_v21_logo', aturan: 'sppg_v21_aturan',
            pejabat: [
                {n:"Fadlan Kharisma Aji Nugroho, S.Pd", j:"Ka SPPG Kulon Progo Panjatan Panjatan 2"},
                {n:"Ismiyati", j:"Perwakilan Yayasan YPPSDP"},
                {n:"Fadlan Kharisma Aji Nugroho, S.Pd ", j:"Ka SPPG Kulon Progo Panjatan Panjatan 2 "},
                {n:"Ririn Sri Lestari", j:"Pemilik Dapur"},
                {n:"Ana Febriani, A.md.Gz", j:"Ahli Gizi"},
                {n:"Rezky Windu Antara, S.Ak.", j:"Akuntan"}
            ]
        };

        let listTTD = [{...CONFIG.pejabat[0], s:"Yang Melaporkan"}, {...CONFIG.pejabat[1], s:"Mengetahui"}];
        let listAturan = JSON.parse(localStorage.getItem(CONFIG.aturan) || "[]");
        let logoBase64 = localStorage.getItem(CONFIG.logo);

        // === INIT ===
        document.getElementById('tglSurat').valueAsDate = new Date();
        document.getElementById('apiKey').value = localStorage.getItem(CONFIG.api) || "";
        if(logoBase64) showLogo(logoBase64);
        renderTTD(); renderAturan(); updateNomor();

        // === LISTENERS ===
        document.getElementById('apiKey').addEventListener('input', (e) => localStorage.setItem(CONFIG.api, e.target.value));
        document.getElementById('noUrut').addEventListener('input', updateNomor);
        document.getElementById('tglSurat').addEventListener('change', updateNomor);

        // === LOGO HANDLING ===
        document.getElementById('logoInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            Swal.fire({title:'Memproses Logo...', didOpen:()=>Swal.showLoading()});
            const r = new FileReader();
            r.onload = function(ev) {
                const img = new Image();
                img.onload = function() {
                    const cvs = document.getElementById('compressCanvas');
                    const ctx = cvs.getContext('2d');
                    const scale = 300 / img.width; 
                    cvs.width = 300; cvs.height = img.height * scale;
                    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,cvs.width,cvs.height); // White BG
                    ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                    const d = cvs.toDataURL('image/jpeg', 0.95);
                    try { localStorage.setItem(CONFIG.logo, d); logoBase64=d; showLogo(d); Swal.fire('Sip!', 'Logo beres.', 'success'); } 
                    catch(err) { Swal.fire('Full', 'Storage penuh.', 'error'); }
                }
                img.src = ev.target.result;
            }
            r.readAsDataURL(file);
        });
        function showLogo(s) { document.getElementById('logoImg').src=s; document.getElementById('logoBox').classList.remove('hidden'); }
        function hapusLogo() { Swal.fire({title:'Hapus?',showCancelButton:true}).then(r=>{if(r.isConfirmed){localStorage.removeItem(CONFIG.logo);logoBase64=null;document.getElementById('logoBox').classList.add('hidden');}})}

        // === ATURAN & TTD ===
        function renderAturan(){const s=document.getElementById('dbAturan');s.innerHTML='<option value="">-- DB Aturan --</option>';listAturan.forEach((x,i)=>{let o=document.createElement('option');o.value=i;o.text=`${x.n}`;s.appendChild(o)});}
        function simpanAturan(){const n=document.getElementById('dasarNomor').value,t=document.getElementById('dasarTanggal').value,p=document.getElementById('dasarPerihal').value;if(n&&p){listAturan.push({n,t,p});localStorage.setItem(CONFIG.aturan,JSON.stringify(listAturan));renderAturan();}}
        function hapusAturan(){const i=document.getElementById('dbAturan').value;if(i!==""){listAturan.splice(i,1);localStorage.setItem(CONFIG.aturan,JSON.stringify(listAturan));renderAturan();}}
        function pilihAturan(){const i=document.getElementById('dbAturan').value;if(i!==""){const x=listAturan[i];document.getElementById('dasarNomor').value=x.n;document.getElementById('dasarTanggal').value=x.t;document.getElementById('dasarPerihal').value=x.p;}}
        function toggleHukum(){document.getElementById('boxHukum').classList.toggle('hidden');}
        
        function renderTTD(){const c=document.getElementById('ttdContainer');c.innerHTML='';listTTD.forEach((t,i)=>{let ops='';CONFIG.pejabat.forEach(p=>ops+=`<option value="${p.n}|${p.j}">${p.n}</option>`);let d=document.createElement('div');d.className="bg-slate-50 p-2 rounded border text-xs";d.innerHTML=`<div class="flex justify-between mb-1"><span class="font-bold text-slate-400">#${i+1}</span>${i>1?`<button onclick="listTTD.splice(${i},1);renderTTD()" class="text-red-500">‚úï</button>`:''}</div><select onchange="let[n,j]=this.value.split('|');listTTD[${i}].n=n;listTTD[${i}].j=j;renderTTD()" class="input-std mb-1">${ops}</select><input oninput="listTTD[${i}].s=this.value" value="${t.s}" class="input-std mb-1"><input oninput="listTTD[${i}].n=this.value" value="${t.n}" class="input-std font-bold"><input oninput="listTTD[${i}].j=this.value" value="${t.j}" class="input-std text-slate-500">`;c.appendChild(d);});}
        function tambahTTD(){if(listTTD.length<4){listTTD.push({n:"",j:"",s:"Saksi"});renderTTD();}}

        // === AUTO MODEL ===
        async function cekKoneksi() {
            const k=document.getElementById('apiKey').value; if(!k) return Swal.fire('Isi API Key','','warning');
            const b=document.getElementById('statusAI'); b.innerText="Checking...";
            try { 
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${k}`);
                const d = await r.json();
                if(d.error) throw new Error(d.error.message);
                const ms = d.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                const s = document.getElementById('modelSelect'); s.innerHTML = "";
                ms.forEach(m => { let o=document.createElement('option'); o.value=m.name.replace("models/",""); o.text=m.displayName; s.appendChild(o); });
                b.innerText="Online ‚úÖ"; b.className="text-[10px] bg-green-100 px-2 py-0.5 rounded text-green-600 font-bold";
                Swal.fire('Sip!', 'Model AI siap.', 'success');
            } catch(e){ 
                b.innerText="Error ‚ùå"; Swal.fire('Gagal', e.message, 'error'); 
            }
        }

        // === AI GENERATOR (V21: PADAT & JELAS) ===
        async function generateAI() {
            const k=document.getElementById('apiKey').value, m=document.getElementById('masalah').value, mod=document.getElementById('modelSelect').value;
            if(!k||!m) return Swal.fire('Data Kurang','Isi API Key & Masalah','warning');
            
            Swal.fire({title:'AI Sedang Bekerja...', didOpen:()=>Swal.showLoading()});
            
            // Konteks Waktu
            const d = new Date(document.getElementById('tglSurat').value);
            const hari = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"][d.getDay()];
            const bulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][d.getMonth()];
            const pembuka = `Pada hari ini <b>${hari}</b>, tanggal <b>${d.getDate()}</b> bulan <b>${bulan}</b> tahun <b>${d.getFullYear()}</b>, bertempat di Kantor SPPG Kulon Progo Panjatan Panjatan 2, kami yang bertanda tangan di bawah ini menerangkan bahwa:`;
            
            let hk=""; if(document.getElementById('cekHukum').checked){ const dn=document.getElementById('dasarNomor').value; const dp=document.getElementById('dasarPerihal').value; if(dn) hk=`DASAR HUKUM: ${dn} tentang ${dp}.`; }

            // PROMPT UPGRADED (V21: PRECISION)
            const prompt = `
            Role: Sekertaris Negara.
            Tugas: Buat Isi Berita Acara yang tegas, sedikit detail, lugas.
            Masalah: "${m}". ${hk}
            
            INSTRUKSI STRUKTUR OUTPUT:
            1. BRIDGING: Kalimat pengantar formal. Contoh: "Berdasarkan evaluasi lapangan, disampaikan hal-hal berikut:"
            2. ISI Uraikan secara poin-poin 1, 2 dst mengenai [Barang yang diserahterimakan/Poin kesepakatan/Kronologi kejadian] secara objektif:
               - Sebutkan Kejadiannya: misal, Serah Terima Jabatan/Kerusakan Barang/Kesepakatan Rapat
               - Gunakan bahasa Indonesia formal yang sesuai dengan EBI (Ejaan Bahasa Indonesia) dan hindari kata-kata ambigu
               - Tulis kalimat EFEKTIF dan LUGAS (to the poin).
               - Tetap sertakan ALASAN/SEBAB-AKIBAT yang logis.
               - Fokus pada mengalir inti masalah kemudian solusi.
               
            3. CLOSING: Klausul Legalitas: "Tambahkan klausul bahwa dokumen ini dibuat dalam keadaan sadar dan tanpa paksaan dan 1 Kalimat penutup formal.
            
            LARANGAN:
            - JANGAN ulangi kalimat pembuka "Pada hari ini...".
            - JANGAN pakai bahasa puitis/berbunga-bunga.
            - HINDARI kata sambung yang berlebihan.
            `;

            try {
                const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${mod}:generateContent?key=${k}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                const res = await req.json();
                if(res.error) throw new Error(res.error.message);
                
                let raw = res.candidates[0].content.parts[0].text;
                let cleanHtml = marked.parse(raw);
                
                document.getElementById('editor').innerHTML = `<p>${pembuka}</p>` + cleanHtml;
                Swal.fire('Selesai', 'Poin-poin padat & jelas sudah siap.', 'success');
            } catch(e) { Swal.fire('Gagal', e.message, 'error'); }
        }

        // === PDF DOWNLOAD ===
        function downloadPDF() {
            const html = document.getElementById('editor').innerHTML;
            if(html.includes("Isi Berita Acara")) return Swal.fire('Kosong','','warning');
            
            const val = htmlToPdfmake(html, {
                defaultStyles: {
                    p: { fontSize: 11, lineHeight: 1.25, margin: [0, 0, 0, 8], alignment: 'justify' },
                    ul: { margin: [0, 0, 0, 8] },
                    li: { fontSize: 11, lineHeight: 1.25, alignment: 'justify', margin:[0,0,0,4] }
                }
            });

            const inst = document.getElementById('namaInstansi').value;
            const almt = document.getElementById('alamatInstansi').value;
            const almt2 = document.getElementById('alamatLengkap').value;
            const kont = document.getElementById('kontakInstansi').value;

            // HEADER: 3 Kolom
            const headerTable = {
                margin: [0, 0, 0, 5],
                table: {
                    widths: [80, '*', 80],
                    body: [[
                        { image:logoBase64||'', width:70, border:[false,false,false,false] },
                        { 
                            stack:[
                                {text:inst, fontSize:14, bold:true},
                                {text:almt, fontSize:10, bold:true},
                                {text:almt2, fontSize:10},
                                {text:kont, fontSize:9, italics:true}
                            ], 
                            alignment:'center', margin:[0,5,0,0], border:[false,false,false,false] 
                        },
                        { text:'', border:[false,false,false,false] }
                    ]]
                }, layout:'noBorders'
            };

            const ttdCols = listTTD.map(t=>({
                stack:[
                    {text:(t.s||'Mengetahui')+',', alignment:'center', margin:[0,0,0,50]},
                    {text:t.n, bold:true, decoration:'underline', alignment:'center'},
                    {text:t.j, alignment:'center', fontSize:10}
                ]
            }));
            const ttdBlock = ttdCols.length<=2 ? {columns:ttdCols, columnGap:10} : {stack:[{columns:ttdCols.slice(0,2),columnGap:10,margin:[0,0,0,20]},{columns:ttdCols.slice(2),columnGap:10}]};

            const d=new Date(document.getElementById('tglSurat').value);
            const tglStr=`${d.getDate()} ${["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][d.getMonth()]} ${d.getFullYear()}`;
            const no=document.getElementById('noSuratFinal').value;

            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [85, 40, 56, 40], 
                content: [
                    logoBase64 ? headerTable : {text:inst, alignment:'center', fontSize:14, bold:true, margin:[0,0,0,10]},
                    {canvas:[{type:'line', x1:0, y1:0, x2:460, y2:0, lineWidth:2, lineColor:'black'}], alignment:'center'}, 
                    {canvas:[{type:'line', x1:0, y1:2, x2:460, y2:2, lineWidth:0.5, lineColor:'black'}], alignment:'center', margin:[0,0,0,20]},
                    
                    {text:'BERITA ACARA', fontSize:12, bold:true, decoration:'underline', alignment:'center'},
                    {text:'Nomor: '+no, fontSize:11, alignment:'center', margin:[0, 0, 0, 20]},
                    
                    val,
                    
                    {text:'\n'},
                    {
                        unbreakable: true,
                        stack: [
                            {text:`Kulon Progo, ${tglStr}`, alignment:'center', margin:[0,0,0,10]},
                            ttdBlock
                        ]
                    }
                ],
                defaultStyle: { font: 'Roboto', fontSize: 11, lineHeight: 1.25 }
            };
            pdfMake.createPdf(docDefinition).download(`BA_${no.replace(/\//g,'-')}.pdf`);
        }

        function updateNomor(){const n=document.getElementById('noUrut').value,d=new Date(document.getElementById('tglSurat').value),r=["","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"];document.getElementById('noSuratFinal').value=`${n}/SPPG/${r[d.getMonth()+1]}/${d.getFullYear()}`;}
        function cmd(c){document.execCommand(c,false,null);}
        function togglePass(){const x=document.getElementById('apiKey');x.type=x.type==='password'?'text':'password';}
        function toggleCase(){const s=window.getSelection(),t=s.toString();if(t)document.execCommand('insertText',false,t===t.toUpperCase()?t.toLowerCase():t.toUpperCase());}
        function simpanApp(){Swal.fire({title:'Simpan App?',showCancelButton:true}).then(r=>{if(r.isConfirmed){let h=document.documentElement.outerHTML;h=h.replace("localStorage.getItem(CONFIG.logo)",`'${logoBase64||''}'`).replace("localStorage.getItem(CONFIG.api)||\"\"",`'${document.getElementById('apiKey').value}'`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([h],{type:'text/html'}));a.download='SPPG-BA-V21-Precision.html';a.click();}})}
    </script>
</body>
</html>





